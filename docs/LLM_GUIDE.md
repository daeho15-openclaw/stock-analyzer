# LLM 기반 리포트 해설 가이드

## 개요

Claude API를 사용하여 자연어 해설을 자동 생성하는 기능입니다. 기계적인 수치 나열 대신 전문 애널리스트처럼 읽기 쉬운 설명을 제공합니다.

## 기능

### 1. 종목별 상세 분석
각 종목에 대해 2-3문장의 자연스러운 해설을 생성합니다.

**LLM 비활성화 시**:
```
과매수 80%, 매도 고려 골든크로스, 강세
```

**LLM 활성화 시**:
```
삼성전자는 볼린저 밴드 기준 과매수 구간에 진입하여 단기 조정 가능성이 높아 보입니다. 
다만 일목균형표에서 골든크로스가 나타나며 중장기 상승 추세는 유지되고 있어, 
단기 차익 실현 후 재진입을 고려하는 전략이 적절할 것으로 판단됩니다.
```

### 2. 시장 전체 시황 요약
전체 종목의 분석 결과를 바탕으로 시장 동향을 요약합니다.

**LLM 비활성화 시**:
```
한국 시장 전체 2개 종목 중 1개 종목이 강한 매수 신호를 보이고 있습니다.
```

**LLM 활성화 시**:
```
오늘 한국 주식 시장은 종목별 차별화가 두드러집니다. 
조선업종의 한화오션이 기술적 지표상 강한 매수 신호를 보이며 반등 모멘텀을 확보한 반면, 
반도체 대장주인 삼성전자는 단기 과열 구간에 진입하여 차익 실현 압력이 예상됩니다. 
투자자들은 업종별 강약을 고려한 선별적 접근이 필요해 보입니다.
```

## 설정 방법

### 1. Anthropic API 키 발급

⚠️ **중요**: OpenClaw의 OAuth token은 Anthropic 공식 API에서 지원하지 않습니다!  
별도로 API 키를 발급받아야 합니다.

1. https://console.anthropic.com/ 접속
2. 회원가입 및 로그인
3. API Keys 메뉴에서 새 키 생성
4. 키 복사 (예: `sk-ant-api03-...`)

### 2. 환경 변수 설정

#### Linux/Mac
```bash
# ~/.bashrc 또는 ~/.zshrc에 추가
export ANTHROPIC_API_KEY="sk-ant-api03-..."

# 적용
source ~/.bashrc
```

#### Windows (PowerShell)
```powershell
# 사용자 환경 변수 설정
[System.Environment]::SetEnvironmentVariable('ANTHROPIC_API_KEY', 'sk-ant-api03-...', 'User')

# 현재 세션만
$env:ANTHROPIC_API_KEY="sk-ant-api03-..."
```

#### 임시 설정 (한 번만 사용)
```bash
ANTHROPIC_API_KEY="sk-ant-api03-..." python3 main.py -m kr
```

### 3. 설정 파일 수정

`config/report.yml`:
```yaml
# LLM 기반 해설 생성 활성화
use_llm: true

# 모델 선택 (haiku가 더 빠르고 저렴)
llm_model: "claude-3-5-haiku-20241022"
# llm_model: "claude-3-5-sonnet-20241022"  # 더 높은 품질
```

### 4. 실행
```bash
cd src
python3 main.py -m kr
```

**출력 예시**:
```
✅ Claude API 연결 성공 (모델: claude-3-5-haiku-20241022)
📊 KR 시장 분석 시작 (2026-02-10)
...
✅ 리포트 저장: ../reports/kr_2026-02-10.md
```

## 모델 선택

| 모델 | 속도 | 비용 | 품질 | 추천 용도 |
|------|------|------|------|----------|
| **claude-3-5-haiku-20241022** | 빠름 | 저렴 | ⭐⭐⭐⭐ | 일일 리포트 (권장) |
| **claude-3-5-sonnet-20241022** | 느림 | 비쌈 | ⭐⭐⭐⭐⭐ | 주간/월간 심층 분석 |

## 비용

### Haiku (권장)
- **입력**: $0.25 / 1M tokens
- **출력**: $1.25 / 1M tokens

**예상 비용** (종목 10개 기준):
- 종목별 분석: ~200 tokens × 10 = 2,000 tokens 출력
- 시황 요약: ~500 tokens 출력
- **총 비용**: ~$0.003 (약 4원/리포트)

### Sonnet
- **입력**: $3 / 1M tokens
- **출력**: $15 / 1M tokens
- **총 비용**: ~$0.04 (약 50원/리포트)

## 동작 방식

### 프롬프트 예시 (종목 분석)
```
당신은 주식 애널리스트입니다. 다음 기술적 분석 결과를 바탕으로 
투자자가 이해하기 쉽게 해설해주세요.

종목: 삼성전자 (005930)
현재가: 165,800원
등락률: -0.36%

볼린저 밴드 분석:
- 점수: 1.0/4.0
- 코멘트: 과매수 80%, 매도 고려

일목균형표 분석:
- 점수: 4.0/4.0
- 코멘트: 골든크로스, 강세

종합 평가: 👌 (2.5/4.0)

2-3문장으로 간결하게 설명하되, 투자 시사점을 포함해주세요.
```

### 에러 처리

API 호출 실패 시 자동으로 Fallback (기본 코멘트)으로 전환됩니다:

```python
⚠️  Claude API 호출 실패 (삼성전자): timeout
# → 기본 코멘트 사용: "과매수 80%, 매도 고려 골든크로스, 강세"
```

## 리포트 비교

### Markdown (LLM 활성화)
```markdown
## 💡 시황 요약

- 총 2개 종목 분석
- 강한 매수 신호 🔥: 1개
- 중립/관망 👌: 1개

### 💬 시장 분석
오늘 한국 주식 시장은 종목별 차별화가 두드러집니다. 
조선업종의 한화오션이 기술적 지표상 강한 매수 신호를 보이며...

---

## 📝 종목별 상세 분석

### 👌 삼성전자
**현재가**: 165,800원 (-0.36%)

삼성전자는 볼린저 밴드 기준 과매수 구간에 진입하여...
```

### HTML (LLM 활성화)
시황 분석과 종목별 상세 분석이 카드 형태로 추가됩니다.

## 문제 해결

### API 키 오류
```
⚠️  ANTHROPIC_API_KEY가 설정되지 않았습니다. LLM 기능이 비활성화됩니다.
```
→ 환경 변수 설정 확인

### anthropic 패키지 없음
```
⚠️  anthropic 패키지가 설치되지 않았습니다.
```
→ `pip install anthropic`

### API 호출 실패
```
⚠️  Claude API 호출 실패 (삼성전자): timeout
```
→ 네트워크 확인, 재시도

## LLM 없이 사용

`config/report.yml`:
```yaml
use_llm: false  # LLM 비활성화
```

기본 템플릿 기반 코멘트만 사용하여 API 비용 없이 사용 가능합니다.

---

**문서 버전**: 1.0  
**최종 수정**: 2026-02-10
